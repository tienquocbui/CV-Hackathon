<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header class="navbar">
        <div class="navbar-logo">
            <a href="/"><img src="/static/assets/logo.png" alt="Speakly Logo"></a>
        </div>
        <nav class="navbar-menu">
            <a href="/">Home</a>
            <a href="/about" class="{% if request.path == '/about' %}active{% endif %}">About</a>
            <a href="#features">Features</a>
            <a href="#pricing">Pricing</a>
            <a href="#contact">Contact</a>
        </nav>

        <div class="navbar-icons">
            <a href="#accessibility">Accessibility</a>
        </div>
        
    </header>

    <section class="demo-content">
        <div class="demo-text-block">
            <h1 class="demo-title">Demo Recording</h1>
            <!-- <p class="demo-description">Click the button to record. We'll refine your speech into a professional CV entry.</p> -->
            <p id="questionText" class="demo-description">{{ question_text }}</p> <!-- Dynamic text here -->
        </div>

        <div class="buttons">
            <button id="recordBtn" class="btn record-btn">Start Recording</button>
        </div>

        <div id="result" class="transcript-box">Refined transcript will appear here...</div>
        <!-- <div class="buttons" style="display:none;" id="actionButtons">
            <button id="improveBtn" class="btn improve-btn">Improve with AI</button>
            <a id="downloadBtn" class="btn download-btn" style="display:none;" href="#">Download CV (PDF)</a>
        </div> -->
        <p></p>
        <!-- <div class="buttons" style="display:none;" id="docxActions">
            <button id="generateDocxBtn" class="btn">Generate DOCX</button>
            <a id="downloadDocxBtn" class="btn" style="display:none;" href="#">Download CV (DOCX)</a>
        </div> -->
        <div class="buttons">
            <button id="generateDocxBtn" class="btn">Generate DOCX</button>
        </div>
    </section>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const resultDiv = document.getElementById('result');
        const improveBtn = document.getElementById('improveBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        // const actionButtons = document.getElementById('actionButtons');
        const docxActions = document.getElementById('docxActions');
        const generateDocxBtn = document.getElementById('generateDocxBtn');
        const downloadDocxBtn = document.getElementById('downloadDocxBtn');
        let currentIndex = 0; // Declare global variable
        let mediaRecorder, audioChunks = [], transcriptText = '';
        let question_key = '';
        let structuredData = {};
        fetchNextQuestion();  // Load the first question on page load
        function fetchNextQuestion() {
            fetch(`/next_question?index=${currentIndex}`)
                .then(response => response.json())
                .then(data => {
                    if (data.question) {
                        questionText.textContent = data.question; 
                        question_key = data.key; // Update question text dynamically
                    } else {
                        questionText.textContent = "Adll questions completed.";
                        // actionButtons.style.display = 'block';
                    }
                });
        }

        recordBtn.addEventListener('click', async () => {
            if (recordBtn.textContent === 'Start Recording') {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                let formData = new FormData();
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    formData.append('audio', audioBlob, 'recording.wav');
                    formData.append('question_key', question_key);
                    console.log(formData);
                    resultDiv.innerHTML = 'Processing transcript...';
                    // actionButtons.style.display = 'none';

                    try {
                        const response = await fetch('/transcribe', { method: 'POST', body: formData });
                        const data = await response.json();
                        transcriptText = data.text;
                        console.log("bf",structuredData);
                        structuredData[question_key] = data.structured_data[question_key]
                        console.log("at",structuredData);
                        resultDiv.innerHTML = `<strong>Raw Transcript:</strong><br>${transcriptText || 'No text recognized.'}`;
                        // actionButtons.style.display = 'block';
                        currentIndex++;
                        fetchNextQuestion();
                    } catch {
                        resultDiv.innerHTML = 'Error processing audio.';
                    }
                };
                console.log(transcriptText);
                mediaRecorder.start();
                recordBtn.textContent = 'Stop Recording';
                fetchNextQuestion();  // Load the first question on page load
            } else {
                mediaRecorder.stop();
                fetchNextQuestion();  // Load the first question on page load
                recordBtn.textContent = 'Start Recording';
            }
        });

        // improveBtn.addEventListener('click', async () => {
        //     resultDiv.innerHTML = 'Refining transcript...';

        //     try {
        //         const response = await fetch('/improve', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify({ text: transcriptText })
        //         });
        //         const data = await response.json();
        //         resultDiv.innerHTML = `<strong>Improved CV:</strong><br>${data.improved_text}`;
        //         downloadBtn.href = data.pdf_url;
        //         downloadBtn.style.display = 'inline-block';
        //     } catch {
        //         resultDiv.innerHTML = 'Error improving transcript.';
        //     }
        // });
        generateDocxBtn.addEventListener('click', async () => {
            resultDiv.innerHTML = 'Generating DOCX file...';
            try {
                console.log("std",structuredData);
                const response = await fetch('/generate_docx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ structured_data: structuredData })
                });
                console.log(response);
                const data = await response.json();
                if (data.file) {
                    resultDiv.innerHTML = `<a href="${data.html_file}" target="_blank">Download your DOCX CV</a>`;
                }
            } catch (err){
                console.error('Error:', err);
                resultDiv.innerHTML = 'Error generating DOCX.';
            }
        });

    </script>

    <footer class="footer">
        <p>&copy; 2025 Speakly. All Rights Reserved.</p>
    </footer>

</body>
</html>